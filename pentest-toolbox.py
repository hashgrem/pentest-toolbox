"""
Project name: Pentest ToolBox
Version: 1.0
Copyright© x/x/2022, DEMARD Jérémy et Xavier 

"""

from modules.cvelookup import CVELookUp
from modules.searchsploit import searchsploit
from modules.dnslookup import DNSLookUp
from modules.certificate import getCertificate
from modules.portscan import Nmap
from modules.usernamecheck import checkusername
from modules.phonereverse import lookuphone
from modules.whoisrecon import whois_query
from modules.revshellgenerator import reverse_shells
from modules.fakeidentity import generate_fake_identity
from modules.webscan import check_server, check_robots_txt
from modules.fpdf import renderHTML
from menu import displayHeader, displayMenu, ReconMenu, ScanningMenu, ExploitMenu, OsintMenu
from datetime import datetime
import os

if __name__ == "__main__":

    displayHeader()
    displayMenu()
    HTML = ""
    HTML += f"<h1>Rapport du {datetime.now()}</h1><br>"

    option = int(input(">>> Choose an option\n>>> "))
    while option != 99:
        if option == 1:
            ReconMenu()
            subOption = str(input(">>> Choose an option\n>>> "))
            while subOption != 'z':
                if subOption == 'a':
                    domain = str(input(">>> Type a domain name\n>>> "))
                    print(whois_query(domain))
                if subOption == 'b':
                    CVE_ID = str(input(">>> Enter a CVE id (ex: CVE-2021-40438)\n>>> "))
                    print(CVELookUp(CVE_ID))
                    
                if subOption == 'c':
                    DNS_DOMAIN = str(input(">>> Enter a domain name\n>>> "))
                    dns_lookup = DNSLookUp(DNS_DOMAIN)
                    print(dns_lookup)
                    
                    
                if subOption == 'd':
                    CERTIF = str(input(">>> Enter a domain name\n>>> "))
                    certif = getCertificate(CERTIF)
                    print(certif)
                    
                ReconMenu()
                subOption = str(input(">>> Choose an option\n>>> "))

        
        elif option == 2:
            ScanningMenu()
            subOption = str(input(">>> Choose an option\n>>> "))
            while subOption != 'z':
                if subOption == 'a':
                    scan, version = Nmap('supdevinci.fr')
                    print(scan)
                if subOption == 'b':
                    URL = str(input(">>> Type target URL (http://example.com)\n>>> "))
                    check_server(URL, False)
                    check_robots_txt(URL)

                ScanningMenu()
                subOption = str(input(">>> Choose an option\n>>> "))

        elif option == 3:
            service = str(input(">>> Search for exploits on a service (ex: wordpress 4.0)\n>>> "))
            exploit = searchsploit(service)
            print(exploit)

        elif option == 4:
            OsintMenu()
            subOption = str(input(">>> Choose an option\n>>> "))
            while subOption != 'z':
                if subOption == 'a':
                    user = str(input(">>> Enter a username\n>>> "))
                    usernamecheck = checkusername(user)
                    print(usernamecheck)
                if subOption == 'c':
                    numberphone = str(input(">>> Enter a phone number in international format (ex: 33969370364)\n>>> "))
                    phone = lookuphone(numberphone)
                    print(phone)
                if subOption == 'e':
                    local = 'fr_FR'
                    fake_identity = generate_fake_identity(local)
                    print(fake_identity)

                OsintMenu()
                subOption = str(input(">>> Choose an option\n>>> "))
        
        elif option == 5:
            domain = str(input(">>> Enter target domain name\n>>> "))
            URL = "http://"+domain

            print("\n>>> Generating PDF...")
            print(f">>> Started at {datetime.now()}")

            # DNS
            HTML += f"<h2>Informations DNS {domain}</h2><br>"
            HTML += f"<p>{DNSLookUp(domain, True)}</p>"
            print(">>> DNS done")

            # Certificat
            HTML += f"<h2>Informations sur le certificat {domain}</h2><br>"
            HTML += f"<p>{getCertificate(domain, True)}</p>"
            print(">>> Certificate done")

            # Scan NMAP
            resScan, versions = Nmap(domain, True)
            HTML += f"<h2>Scan de port sur {domain}</h2><br>"
            HTML += f"<p>{resScan}</p>"
            print(">>> Nmap scan done")

            # Exploits
            HTML += f"<h2>Potentielles vulnérabilités trouvées</h2><br>"
            for vuln in versions:
                HTML += f"<h3>Service: {vuln}</h3><br><p>{searchsploit(vuln, True)}</p><br>"
            print(">>> Searchsploit done")
            

            # Web scan
            HTML += f"<h2>Scan web</h2><br>"
            res = check_server(URL, True)
            HTML += res
            print(">>> Web scan done")
            #check_robots_txt(URL)

            renderHTML(HTML) # Generate PDF
            PATH = str(os.getcwd() + '\\result.pdf')
            print(f">>> PDF created successfully at {PATH}")
            print(f">>> Ended at {datetime.now()}\n")
            break
        elif option == 6:
            IP = str(input(">>> Type your LHOST\n>>> "))
            PORT = str(input(">>> Type your LPORT\n>>> "))
            shells = reverse_shells(IP, PORT)

            print("\n\n===================================")
            print("Reverse shells one liner")
            print("===================================\n")
            for cmd, value in shells.items():
                print(f"{cmd}\t=>\t{value}")

        displayMenu()
        option = int(input(">>> Choose an option\n>>> "))

 
    

    
    

    